#
# Update Consumer Template Flake Lock Workflow
#
# Automatically updates the flake.lock file in templates/consumer/ when:
# 1. The template's flake.nix file changes
# 2. The stable tag is updated (baseline promotion)
#
# Triggered by: changes to template flake.nix, stable tag updates, manual trigger
# Purpose: Keep consumer template synchronized with latest baseline stable version
# Output: Creates PR with updated flake.lock for template-based consumption pattern
#

name: Update Consumer Template Flake Lock

on:
  push:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  update-flake-lock:
    if: >
      github.event_name == 'workflow_dispatch' ||
      (github.event_name == 'push' && github.ref == 'refs/tags/stable') ||
      (github.event_name == 'push' && github.ref == 'refs/heads/main' &&
       contains(github.event.head_commit.modified, 'templates/consumer/flake.nix'))
    uses: Lineage-org/.github/.github/workflows/lineage-flake-lock-update.yml@stable
    with:
      flake-directory: 'templates/consumer'
      commit-message: 'Update consumer template flake.lock'
      validate-after-update: true
      create-pr: true
      enable-auto-merge: true
